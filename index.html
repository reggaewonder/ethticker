<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Ticker | Debug Mode</title>
    <link rel="icon" href="https://assets.coingecko.com/coins/images/279/small/ethereum.png?1595348880" type="image/x-icon">
    
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root { --bg: #0b0e11; --card: #181a20; --text: #eaecef; --green: #02c076; --red: #cf304a; --border: #2b2f36; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 15px 25px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .content-left { flex: 3; display: flex; flex-direction: column; padding: 20px; overflow-y: hidden; }
        .sidebar-news { flex: 1; background: var(--card); border-left: 1px solid var(--border); display: flex; flex-direction: column; min-width: 300px; }
        
        .main-price { font-size: 3.5rem; font-weight: bold; font-family: 'Monaco', monospace; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 6px; border: 1px solid var(--border); }
        .stat-label { color: #848e9c; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; font-weight: 600; }

        /* CHART CONTAINER */
        #chart-container { flex: 1; background: var(--card); border-radius: 6px; border: 1px solid var(--border); overflow: hidden; position: relative; min-height: 300px; }
        
        /* ERROR LOGGING STYLES */
        #debug-log { position: absolute; top: 10px; left: 10px; color: #ff9900; font-family: monospace; font-size: 12px; z-index: 100; pointer-events: none; }
        .critical-error { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(207, 48, 74, 0.9); padding: 20px; border-radius: 8px; color: white; text-align: center; z-index: 200; display: none; }

        .up { color: var(--green); }
        .down { color: var(--red); }
        
        @media (max-width: 900px) {
            .main-container { flex-direction: column; overflow-y: auto; }
            .sidebar-news { height: auto; min-height: 300px; }
            #chart-container { min-height: 350px; }
        }
    </style>
</head>
<body>

    <div id="critical-error" class="critical-error">
        <h3>⚠️ SYSTEM ERROR</h3>
        <p id="error-message">Unknown Error</p>
    </div>

    <div class="header">
        <div>
            <div style="color: #848e9c; font-size: 0.8rem; font-weight: bold;">ETHEREUM / USD</div>
            <div id="price" class="main-price">Loading...</div>
        </div>
        <div id="debug-status" style="font-size: 0.8rem; color: #666;">Initializing...</div>
    </div>

    <div class="main-container">
        <div class="content-left">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">High</div><div id="high" class="stat-value">--</div></div>
                <div class="stat-card"><div class="stat-label">Low</div><div id="low" class="stat-value">--</div></div>
                <div class="stat-card"><div class="stat-label">Vol</div><div id="vol" class="stat-value">--</div></div>
            </div>
            <div id="chart-container">
                <div id="debug-log"></div>
            </div>
        </div>

        <div class="sidebar-news">
            <div style="padding:15px; border-bottom:1px solid #2b2f36; font-weight:bold;">NEWS FEED</div>
            <div id="news-feed" style="padding:15px; overflow-y:auto; font-size:0.9rem;"></div>
        </div>
    </div>

   <script>
        let chart, lineSeries;
        let lastPrice = 0;

        // 1. Setup the Chart
        const container = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#181a20' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2b2f36' }, horzLines: { color: '#2b2f36' } },
            width: container.clientWidth,
            height: container.clientHeight,
            timeScale: { timeVisible: true, secondsVisible: true }
        });

        lineSeries = chart.addAreaSeries({
            lineColor: '#02c076',
            topColor: 'rgba(2, 192, 118, 0.4)',
            bottomColor: 'rgba(2, 192, 118, 0.0)',
            lineWidth: 2,
        });

        // 2. CONNECT TO LIVE STREAM (Websocket)
        // We use Binance's "Mini-Ticker" for ETH/USDT
        const connectTicker = () => {
            const socket = new WebSocket('wss://stream.binance.com:9443/ws/ethusdt@miniTicker');

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const currentPrice = parseFloat(data.c); // "c" is the Close (current) price
                
                // Update the visual price
                const priceEl = document.getElementById('price');
                priceEl.innerText = `$${currentPrice.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

                // Visual "Flash" when price moves
                if (currentPrice > lastPrice) {
                    priceEl.style.color = '#02c076'; // Green
                } else if (currentPrice < lastPrice) {
                    priceEl.style.color = '#cf304a'; // Red
                }
                lastPrice = currentPrice;

                // Push to Chart instantly
                lineSeries.update({
                    time: Math.floor(Date.now() / 1000),
                    value: currentPrice
                });

                document.getElementById('debug-status').innerText = "LIVE STREAMING";
            };

            // Auto-reconnect if it drops
            socket.onclose = () => {
                document.getElementById('debug-status').innerText = "RECONNECTING...";
                setTimeout(connectTicker, 3000);
            };
        };

        // 3. Load Historical Data (just once to fill the chart)
        async function loadHistory() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1m&limit=100');
                const data = await res.json();
                const formattedData = data.map(d => ({
                    time: d[0] / 1000,
                    value: parseFloat(d[4])
                }));
                lineSeries.setData(formattedData);
            } catch (e) { console.error("History failed", e); }
        }

        // Initialize
        loadHistory();
        connectTicker();

        window.addEventListener('resize', () => {
            chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
        });
    </script>
</body>
</html>
